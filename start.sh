#!/bin/bash

echo "üéÆ CaseFun - –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞"
echo "======================================"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker
if ! docker ps &> /dev/null; then
    echo "‚ùå Docker –Ω–µ –∑–∞–ø—É—â–µ–Ω!"
    echo "üìù –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏ Docker Desktop –∏ –ø–æ–≤—Ç–æ—Ä–∏ –ø–æ–ø—ã—Ç–∫—É"
    echo ""
    echo "–î–ª—è macOS: –û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Docker Desktop –∏–∑ –ø–∞–ø–∫–∏ –ü—Ä–æ–≥—Ä–∞–º–º—ã"
    exit 1
fi

echo "‚úÖ Docker –∑–∞–ø—É—â–µ–Ω"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "üóÑÔ∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
if ! docker ps | grep -q casefun-db; then
    echo "üöÄ –ó–∞–ø—É—Å–∫ PostgreSQL..."
    docker-compose up -d
    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ë–î (15 —Å–µ–∫)..."
    sleep 15
else
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
cd backend
if ! npx prisma db execute --stdin <<< "SELECT 1;" &> /dev/null 2>&1; then
    echo "üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    npx prisma db push --skip-generate
    npx prisma generate
else
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞"
fi
cd ..
echo ""

echo "======================================"
echo "‚ú® –í—Å—ë –≥–æ—Ç–æ–≤–æ! –ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä—ã..."
echo ""
echo "üìç Frontend: http://localhost:5173"
echo "üìç Backend:  http://localhost:3001"
echo ""
echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏ Ctrl+C"
echo "======================================"
echo ""

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞
npm run dev
